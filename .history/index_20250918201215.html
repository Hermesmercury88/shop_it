<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    canvas { border: 1px solid #000; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</h2>

  <input type="file" id="upload" accept=".xlsx"><br><br>

  <table id="invoiceTable">
    <tr>
      <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
      <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
      <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
      <th>‡∏£‡∏ß‡∏°</th>
    </tr>
  </table>

  <p><b>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</b> <span id="total">0</span> ‡∏ö‡∏≤‡∏ó</p>

  <h3>‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</h3>
  <canvas id="signature" width="300" height="150"></canvas><br>
  <button onclick="saveSignature()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
  <button onclick="clearSignature()">‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>

  <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå</h3>
  <button onclick="exportExcel()">üìä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel</button>
  <button onclick="exportPDF()">üìÑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button>

  <script>
    const table = document.getElementById("invoiceTable");
    let signatureImage = null;

    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel
    document.getElementById('upload').addEventListener('change', function(e){
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheetName = workbook.SheetNames[0];
        const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header:1});
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        sheet.forEach((row, i) => {
          if(i > 0 && row.length > 0){  // ‡∏Ç‡πâ‡∏≤‡∏° header
            let tr = table.insertRow();
            row.forEach((cell, j) => {
              let td = tr.insertCell();
              td.contentEditable = true; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
              td.innerText = cell;
            });
          }
        });
        calculateTotal();
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏°
    function calculateTotal(){
      let total = 0;
      for(let i=1; i<table.rows.length; i++){
        let row = table.rows[i];
        let qty = parseFloat(row.cells[2].innerText) || 0;
        let price = parseFloat(row.cells[3].innerText) || 0;
        row.cells[4].innerText = (qty * price).toFixed(2);
        total += qty * price;
      }
      document.getElementById('total').innerText = total.toFixed(2);
    }

    // Signature Pad
    const canvas = document.getElementById('signature');
    const signaturePad = new SignaturePad(canvas);

    function saveSignature(){
      if (signaturePad.isEmpty()){
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
        return;
      }
      signatureImage = signaturePad.toDataURL("image/png");
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
    }

    function clearSignature(){
      signaturePad.clear();
      signatureImage = null;
    }

    // Export Excel
    function exportExcel(){
      let data = [["‡∏•‡∏≥‡∏î‡∏±‡∏ö","‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô","‡∏£‡∏≤‡∏Ñ‡∏≤","‡∏£‡∏ß‡∏°"]];
      for(let i=1; i<table.rows.length; i++){
        let row = [];
        for(let j=0; j<table.rows[i].cells.length; j++){
          row.push(table.rows[i].cells[j].innerText);
        }
        data.push(row);
      }
      data.push(["","","","‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", document.getElementById('total').innerText]);

      let ws = XLSX.utils.aoa_to_sheet(data);
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Invoice");
      XLSX.writeFile(wb, "invoice.xlsx");
    }

    // Export PDF
    async function exportPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.text("‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á", 90, 10);

      let y = 20;
      doc.text("‡∏•‡∏≥‡∏î‡∏±‡∏ö  ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£          ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô   ‡∏£‡∏≤‡∏Ñ‡∏≤   ‡∏£‡∏ß‡∏°", 10, y);
      y += 10;
      for(let i=1; i<table.rows.length; i++){
        let row = table.rows[i];
        let text = `${row.cells[0].innerText}   ${row.cells[1].innerText}   ${row.cells[2].innerText}   ${row.cells[3].innerText}   ${row.cells[4].innerText}`;
        doc.text(text, 10, y);
        y += 10;
      }
      y += 10;
      doc.text("‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: " + document.getElementById('total').innerText + " ‡∏ö‡∏≤‡∏ó", 10, y);

      // ‡πÅ‡∏ô‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
      if(signatureImage){
        doc.text("‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:", 10, y+20);
        doc.addImage(signatureImage, "PNG", 50, y+10, 50, 25);
      }

      doc.save("invoice.pdf");
    }
  </script>
</body>
</html>
