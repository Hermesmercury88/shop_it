<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ใบเสร็จรับเงิน</title>

<!-- Site Icons -->
<link rel="shortcut icon" href="pic/logo.png" type="image/x-icon" />
<link rel="icon" href="pic/logo.png" type="image/x-icon" />
<link rel="apple-touch-icon" href="pic/logo.png" />
<link href="css/receipts.css" rel="stylesheet">

</head>
<body>
<div class="container" id="receiptContent">

    <!-- ส่วนหัว -->
    <div class="header-info">
        <div class="company">
            <h2>เอวาริณ คอปเปอร์เรท</h2>
            <p>227 หมู่ 1 ตำบลนาดี อำเภอยางตลาด จังหวัดกาฬสินธุ์ 46120</p>
            <p>โทร. 082-1053870 , 093-4435566</p>
            <p>เลขประจำตัวผู้เสียภาษีอากร 1469900009082</p>
            <p>ทะเบียนการค้าเลขที่ 4611664000007</p>
        </div>
        <div class="logo">
            <img src="./pic/logo.png" alt="logo">
        </div>
    </div>

    <!-- ฟอร์ม -->
    <form action="http://localhost/shop/receipts1.php" method="post" id="receiptForm" enctype="multipart/form-data">

        <div class="doc-title">
            <h2>ใบเสร็จรับเงิน</h2>
            <div class="doc-info">
                <label>เลขที่ / NO. : <input type="text" name="order_no" required></label>
                <span><b>วันที่ / Date :</b> ............................................</span>
            </div>
        </div>

        <div class="customer-info">
            <label>ชื่อลูกค้า: <input type="text" name="customer_name" required></label><br>
            <label>ที่อยู่ลูกค้า: <textarea name="customer_address" rows="2" required></textarea></label>
        </div>

        <br>
        <h3>รายละเอียดสินค้า</h3>
        <table id="itemsTable">
            <thead>
                <tr>
                    <th>ลำดับ</th>
                    <th>รายการ</th>
                    <th>จำนวน</th>
                    <th>ราคา</th>
                    <th>หน่วย</th>
                    <th>ราคารวม</th>
                    <th>ลบ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td><input type="text" name="item_name[]"></td>
                    <td><input type="number" name="qty[]" class="qty"></td>
                    <td><input type="number" name="price[]" class="price"> </td>
                    <td><input type="text" name="unit[]"></td>
                    <td><input type="text" name="total[]" class="total" readonly></td>
                    <td><button type="button" class="remove-btn">-</button></td>
                </tr>
            </tbody>
            <tfoot>
                <!-- รวมเป็นเงินทั้งสิ้น -->
                 <tr>
                    <td colspan="5" style="text-align:center;font-weight:bold;">รวมเป็นเงินทั้งสิ้น</td>
                    <td style="text-align:right;font-weight:bold;">
                        <span id="grandTotalDisplay">0.00</span>
                    </td>
                    <td></td>
                </tr>
                <!-- ตัวอักษร -->
                 <tr>
                    <td colspan="7" style="text-align:left;font-weight:bold;">
                        (ตัวอักษร: <span id="thaiTextDisplay">ศูนย์บาทถ้วน</span>)
                    </td>
                </tr>
            </tfoot>
        </table>

        <input type="hidden" name="grand_total" id="grand_total_input">

        <div class="button-row">
            <button type="button" class="add-btn">+</button>
            <button type="button" class="add-percent">%</button>
            <button type="button" class="add-item-only">เพิ่ม</button>
        </div>

        <div class="pdf-upload-container" style="margin: 15px 0;">
            <label>อัพโหลด PDF: <input type="file" name="pdf_file" accept="application/pdf"></label><br><br>
        </div>
        <button type="button" class="button btn-back" onclick="window.location.href='index.html'">ย้อนกลับ</button>
        <button type="submit" class="button btn-save">บันทึกใบเสร็จ</button>
        <button type="button" class="button btn-print" onclick="printPDF()">พิมพ์ PDF</button>
    </form>

    <div class="signature">
        <br>
        <p>(..............................................................)<br>( นายอภิชาติ พิมพะนิตย์ )<br>ผู้รับเงิน</p>
    </div>
</div>

<script>
// แปลงตัวเลขเป็นภาษาไทย
function numberToThaiText(number) {
    const txtnum = ["ศูนย์","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"];
    const txtdigit = ["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];
    if(number === 0) return "ศูนย์บาทถ้วน";
    let bahtText = "";
    let numStr = number.toFixed(2).toString();
    let [intPart, decPart] = numStr.split(".");
    let intLen = intPart.length;

    for(let i=0; i<intLen; i++){
        let n = parseInt(intPart.charAt(i));
        let pos = intLen - i - 1;
        if(n!==0){
            if(pos==1 && n==1) bahtText += "สิบ";
            else if(pos==1 && n==2) bahtText += "ยี่สิบ";
            else if(pos==0 && n==1 && intLen>1) bahtText += "เอ็ด";
            else bahtText += txtnum[n] + (pos>0?txtdigit[pos]:"");
        }
    }
    bahtText += "บาท";
    if(decPart=="00") bahtText += "ถ้วน";
    else {
        let d1 = parseInt(decPart.charAt(0));
        let d2 = parseInt(decPart.charAt(1));
        if(d1!=0){
            if(d1==1) bahtText += "สิบ";
            else if(d1==2) bahtText += "ยี่สิบ";
            else bahtText += txtnum[d1]+"สิบ";
        }
        if(d2!=0){
            if(d2==1) bahtText += "เอ็ดสตางค์";
            else bahtText += txtnum[d2]+"สตางค์";
        }
    }
    return bahtText;
}

// รวมทุกการคำนวณ
function calculateTotals() {
    let table = document.querySelector("#itemsTable tbody");
    let grandTotal = 0;

    Array.from(table.rows).forEach(row => {
        let qty = parseFloat(row.querySelector(".qty")?.value) || 0;
        let price = parseFloat(row.querySelector(".price")?.value) || 0;
        let totalInput = row.querySelector(".total");
        let itemNameInput = row.querySelector(".item-name");

        let subtotal = qty * price;

        // คำนวณ % ถ้ามี
        if(row.hasAttribute("data-percent")){
            let percent = parseFloat(row.getAttribute("data-percent")) || 0;
            subtotal += subtotal * (percent / 100);

            // อัปเดตชื่อสินค้าให้โชว์ +%
            if(itemNameInput){
                let baseName = itemNameInput.value.split(" +")[0].split(" -")[0];
                itemNameInput.value = percent >= 0 ? `${baseName} +${percent}%` : `${baseName} ${percent}%`;
            }
        }

        if(totalInput) totalInput.value = subtotal.toFixed(2);
        grandTotal += subtotal;
    });

    // แสดงผลรวม
    document.getElementById("grandTotalDisplay").innerText = grandTotal.toFixed(2);
    document.getElementById("grand_total_input").value = grandTotal.toFixed(2);
    document.getElementById("thaiTextDisplay").innerText = numberToThaiText(grandTotal);
}

// Event คำนวณอัตโนมัติ
document.addEventListener("input", function(e){
    if(e.target.classList.contains("qty") || e.target.classList.contains("price") || e.target.classList.contains("item-name")){
        calculateTotals();
    }
});

// อัปเดตเลขลำดับ
function updateRowNumbers(){
    let table = document.querySelector("#itemsTable tbody");
    Array.from(table.rows).forEach((row,index)=>{
        row.cells[0].textContent = index + 1;
    });
}

// เพิ่มแถวสินค้า
document.querySelector(".add-btn").addEventListener("click", function(){
    let table = document.querySelector("#itemsTable tbody");
    let rowCount = table.rows.length;
    let row = table.insertRow();
    row.innerHTML = `
        <td>${rowCount+1}</td>
        <td><input type="text" name="item_name[]" class="item-name" placeholder="กรอกชื่อสินค้า"></td>
        <td><input type="number" name="qty[]" class="qty"></td>
        <td><input type="number" name="price[]" class="price"></td>
        <td><input type="text" name="unit[]"></td>
        <td><input type="text" name="total[]" class="total" readonly></td>
        <td><button type="button" class="remove-btn">-</button></td>
    `;
});

// เพิ่มแถวเปอร์เซ็นต์
document.querySelector(".add-percent").addEventListener("click", function() {
    let percent = prompt("กรอกเปอร์เซ็นต์ (เช่น 10 สำหรับ +10% หรือ -5 สำหรับ -5%)");
    percent = parseFloat(percent);
    if(isNaN(percent)) return alert("กรุณากรอกตัวเลขที่ถูกต้อง");

    let table = document.querySelector("#itemsTable tbody");
    let rowCount = table.rows.length + 1;

    let newRow = table.insertRow();
    newRow.setAttribute("data-percent", percent); // เก็บค่าเปอร์เซ็นต์
    newRow.innerHTML = `
        <td>${rowCount}</td>
        <td><input type="text" name="item_name[]" class="item-name" placeholder="กรอกชื่อสินค้า"></td>
        <td><input type="number" name="qty[]" class="qty"></td>
        <td><input type="number" name="price[]" class="price"></td>
        <td><input type="text" name="unit[]"></td>
        <td><input type="text" name="total[]" class="total" readonly></td>
        <td><button type="button" class="remove-btn">-</button></td>
    `;
});

// ลบแถวสินค้า
document.querySelector("#itemsTable").addEventListener("click", function(e){
    if(e.target.classList.contains("remove-btn")){
        let row = e.target.closest("tr");
        row.parentNode.removeChild(row);
        updateRowNumbers();
        calculateTotals();
    }
});

// ปุ่มเพิ่มแถวเฉพาะช่องรายการ (หมายเหตุ)// ปุ่มเพิ่มแถวเฉพาะช่องรายการ (หมายเหตุ)
document.querySelector(".add-item-only").addEventListener("click", function(){
    let table = document.querySelector("#itemsTable tbody");
    let row = table.insertRow();

    // กำหนด class "note-row" เพื่อแยกจากแถวปกติ
    row.classList.add("note-row");

    row.innerHTML = `
        <td></td>  <!-- ช่องลำดับจะอัปเดตอัตโนมัติ -->
        <textarea name="item_name[]" class="item-name auto-expand" placeholder="กรอกหมายเหตุ/รายการ"></textarea>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td><button type="button" class="remove-btn">-</button></td>
    `;

    // อัปเดตเลขลำดับให้แถวทั้งหมด
    updateRowNumbers();
});


// ปุ่มพิมพ์ PDF
function printPDF() {
    window.print();
}
</script>

</body>
</html>