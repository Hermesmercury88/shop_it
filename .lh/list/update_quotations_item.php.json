{
    "sourceFile": "list/update_quotations_item.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1758607262060,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1758608369993,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,42 +22,43 @@\n     exit;\r\n }\r\n \r\n /*\r\n-  โครงสร้าง $vals จากตาราง quotations\r\n-  [0] = เลขที่ใบเสนอราคา (quotation_no)\r\n-  [1] = เรื่อง (subject)\r\n-  [2] = เรียน (recipient_name)\r\n-  [3] = รายการสินค้า (item_name)\r\n-  [4] = จำนวน (qty)\r\n-  [5] = ราคา (price)\r\n-  [6] = หน่วย (unit)\r\n-  [7] = ราคารวม (total)\r\n+  $vals:\r\n+  [0] = quotation_no\r\n+  [1] = subject\r\n+  [2] = recipient_name\r\n+  [3] = item_name\r\n+  [4] = qty\r\n+  [5] = price\r\n+  [6] = unit\r\n+  [7] = total\r\n */\r\n \r\n-// ✅ update 2 ตาราง (quotations + quotation_items)\r\n $conn->begin_transaction();\r\n \r\n try {\r\n-    // อัพเดทตาราง quotations\r\n-    $sql1 = \"UPDATE quotations q\r\n-             JOIN quotation_items i ON i.quotation_id = q.id\r\n-             SET q.quotation_no = ?, q.subject = ?, q.recipient_name = ?,\r\n-                 i.item_name = ?, i.qty = ?, i.price = ?, i.unit = ?, i.total = ?\r\n-             WHERE i.id = ?\";\r\n-    $stmt = $conn->prepare($sql1);\r\n-    $stmt->bind_param(\"ssssidsdi\", \r\n-        $vals[0], $vals[1], $vals[2], \r\n-        $vals[3], $vals[4], $vals[5], $vals[6], $vals[7], \r\n-        $id\r\n-    );\r\n-    $stmt->execute();\r\n+    // 1️⃣ update ตาราง quotation_items\r\n+    $stmt1 = $conn->prepare(\"UPDATE quotation_items SET item_name=?, qty=?, price=?, unit=?, total=? WHERE id=?\");\r\n+    $stmt1->bind_param(\"sidssi\", $vals[3], $vals[4], $vals[5], $vals[6], $vals[7], $id);\r\n+    $stmt1->execute();\r\n \r\n+    // 2️⃣ update ตาราง quotations (อิงจาก quotation_items.id -> quotation_id)\r\n+    $stmt2 = $conn->prepare(\"\r\n+        UPDATE quotations q\r\n+        JOIN quotation_items i ON i.quotation_id = q.id\r\n+        SET q.quotation_no=?, q.subject=?, q.recipient_name=?\r\n+        WHERE i.id=?\r\n+    \");\r\n+    $stmt2->bind_param(\"sssi\", $vals[0], $vals[1], $vals[2], $id);\r\n+    $stmt2->execute();\r\n+\r\n     $conn->commit();\r\n     echo json_encode([\"success\" => true]);\r\n+\r\n } catch (Exception $e) {\r\n     $conn->rollback();\r\n-    echo json_encode([\"success\" => false, \"message\" => \"บันทึกไม่สำเร็จ\"]);\r\n+    echo json_encode([\"success\" => false, \"message\" => $e->getMessage()]);\r\n }\r\n \r\n $conn->close();\r\n ?>\r\n"
                },
                {
                    "date": 1758609004695,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,64 +1,59 @@\n <?php\r\n header(\"Content-Type: application/json\");\r\n \r\n-// เชื่อมต่อฐานข้อมูล\r\n $host = \"localhost\";\r\n $user = \"root\";\r\n $pass = \"\";\r\n $dbname = \"shop_it\";\r\n+\r\n $conn = new mysqli($host, $user, $pass, $dbname);\r\n-\r\n if ($conn->connect_error) {\r\n-    die(json_encode([\"success\" => false, \"message\" => \"เชื่อมต่อฐานข้อมูลล้มเหลว\"]));\r\n+    echo json_encode([\"success\" => false, \"message\" => \"เชื่อมต่อฐานข้อมูลล้มเหลว\"]);\r\n+    exit;\r\n }\r\n \r\n-// รับข้อมูลจาก fetch\r\n $data = json_decode(file_get_contents(\"php://input\"), true);\r\n-$id   = $data['id'] ?? '';\r\n-$vals = $data['data'] ?? [];\r\n+$id   = $data[\"id\"] ?? null;\r\n+$vals = $data[\"data\"] ?? [];\r\n \r\n-if (!$id || count($vals) < 8) {\r\n+if (!$id || count($vals) < 8) {  \r\n+    // 8 ช่องเพราะมี quotation_no, subject, recipient_name, item_name, qty, price, unit, total\r\n     echo json_encode([\"success\" => false, \"message\" => \"ข้อมูลไม่ครบ\"]);\r\n     exit;\r\n }\r\n \r\n-/*\r\n-  $vals:\r\n-  [0] = quotation_no\r\n-  [1] = subject\r\n-  [2] = recipient_name\r\n-  [3] = item_name\r\n-  [4] = qty\r\n-  [5] = price\r\n-  [6] = unit\r\n-  [7] = total\r\n-*/\r\n+// รับค่าจาก frontend\r\n+$quotation_no   = $vals[0];\r\n+$subject        = $vals[1];\r\n+$recipient_name = $vals[2];\r\n+$item_name      = $vals[3];\r\n+$qty            = $vals[4];\r\n+$price          = $vals[5];\r\n+$unit           = $vals[6];\r\n+$total          = $vals[7];\r\n \r\n-$conn->begin_transaction();\r\n+// ✅ update quotation_items\r\n+$sql_item = \"UPDATE quotation_items \r\n+             SET item_name=?, qty=?, price=?, unit=?, total=? \r\n+             WHERE id=?\";\r\n+$stmt_item = $conn->prepare($sql_item);\r\n+$stmt_item->bind_param(\"sidssi\", $item_name, $qty, $price, $unit, $total, $id);\r\n \r\n-try {\r\n-    // 1️⃣ update ตาราง quotation_items\r\n-    $stmt1 = $conn->prepare(\"UPDATE quotation_items SET item_name=?, qty=?, price=?, unit=?, total=? WHERE id=?\");\r\n-    $stmt1->bind_param(\"sidssi\", $vals[3], $vals[4], $vals[5], $vals[6], $vals[7], $id);\r\n-    $stmt1->execute();\r\n+// ✅ update quotations (เชื่อมโยงด้วยการ subquery หา quotation_id จาก item id)\r\n+$sql_main = \"UPDATE quotations \r\n+             SET quotation_no=?, subject=?, recipient_name=? \r\n+             WHERE id=(SELECT quotation_id FROM quotation_items WHERE id=?)\";\r\n+$stmt_main = $conn->prepare($sql_main);\r\n+$stmt_main->bind_param(\"sssi\", $quotation_no, $subject, $recipient_name, $id);\r\n \r\n-    // 2️⃣ update ตาราง quotations (อิงจาก quotation_items.id -> quotation_id)\r\n-    $stmt2 = $conn->prepare(\"\r\n-        UPDATE quotations q\r\n-        JOIN quotation_items i ON i.quotation_id = q.id\r\n-        SET q.quotation_no=?, q.subject=?, q.recipient_name=?\r\n-        WHERE i.id=?\r\n-    \");\r\n-    $stmt2->bind_param(\"sssi\", $vals[0], $vals[1], $vals[2], $id);\r\n-    $stmt2->execute();\r\n+$success = $stmt_item->execute() && $stmt_main->execute();\r\n \r\n-    $conn->commit();\r\n+if ($success) {\r\n     echo json_encode([\"success\" => true]);\r\n-\r\n-} catch (Exception $e) {\r\n-    $conn->rollback();\r\n-    echo json_encode([\"success\" => false, \"message\" => $e->getMessage()]);\r\n+} else {\r\n+    echo json_encode([\"success\" => false, \"message\" => \"อัปเดตไม่สำเร็จ\"]);\r\n }\r\n \r\n+$stmt_item->close();\r\n+$stmt_main->close();\r\n $conn->close();\r\n-?>\r\n"
                }
            ],
            "date": 1758607262060,
            "name": "Commit-0",
            "content": "<?php\r\nheader(\"Content-Type: application/json\");\r\n\r\n// เชื่อมต่อฐานข้อมูล\r\n$host = \"localhost\";\r\n$user = \"root\";\r\n$pass = \"\";\r\n$dbname = \"shop_it\";\r\n$conn = new mysqli($host, $user, $pass, $dbname);\r\n\r\nif ($conn->connect_error) {\r\n    die(json_encode([\"success\" => false, \"message\" => \"เชื่อมต่อฐานข้อมูลล้มเหลว\"]));\r\n}\r\n\r\n// รับข้อมูลจาก fetch\r\n$data = json_decode(file_get_contents(\"php://input\"), true);\r\n$id   = $data['id'] ?? '';\r\n$vals = $data['data'] ?? [];\r\n\r\nif (!$id || count($vals) < 8) {\r\n    echo json_encode([\"success\" => false, \"message\" => \"ข้อมูลไม่ครบ\"]);\r\n    exit;\r\n}\r\n\r\n/*\r\n  โครงสร้าง $vals จากตาราง quotations\r\n  [0] = เลขที่ใบเสนอราคา (quotation_no)\r\n  [1] = เรื่อง (subject)\r\n  [2] = เรียน (recipient_name)\r\n  [3] = รายการสินค้า (item_name)\r\n  [4] = จำนวน (qty)\r\n  [5] = ราคา (price)\r\n  [6] = หน่วย (unit)\r\n  [7] = ราคารวม (total)\r\n*/\r\n\r\n// ✅ update 2 ตาราง (quotations + quotation_items)\r\n$conn->begin_transaction();\r\n\r\ntry {\r\n    // อัพเดทตาราง quotations\r\n    $sql1 = \"UPDATE quotations q\r\n             JOIN quotation_items i ON i.quotation_id = q.id\r\n             SET q.quotation_no = ?, q.subject = ?, q.recipient_name = ?,\r\n                 i.item_name = ?, i.qty = ?, i.price = ?, i.unit = ?, i.total = ?\r\n             WHERE i.id = ?\";\r\n    $stmt = $conn->prepare($sql1);\r\n    $stmt->bind_param(\"ssssidsdi\", \r\n        $vals[0], $vals[1], $vals[2], \r\n        $vals[3], $vals[4], $vals[5], $vals[6], $vals[7], \r\n        $id\r\n    );\r\n    $stmt->execute();\r\n\r\n    $conn->commit();\r\n    echo json_encode([\"success\" => true]);\r\n} catch (Exception $e) {\r\n    $conn->rollback();\r\n    echo json_encode([\"success\" => false, \"message\" => \"บันทึกไม่สำเร็จ\"]);\r\n}\r\n\r\n$conn->close();\r\n?>\r\n"
        }
    ]
}