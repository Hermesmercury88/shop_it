{
    "sourceFile": "list/upload_all_deliveries1.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1758716597557,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1758717907237,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -24,9 +24,9 @@\n     exit;\r\n }\r\n \r\n // สร้างโฟลเดอร์ถ้ายังไม่มี\r\n-$uploadDir = \"uploads/deliveries/\";\r\n+$uploadDir = \"../uploads/deliveries/\"; // ../ ขึ้นไปหนึ่งระดับ\r\n if(!is_dir($uploadDir)) mkdir($uploadDir,0777,true);\r\n \r\n $newFileName = \"delivery_\".$delivery_id.\"_\".time().\".pdf\";\r\n $uploadPath = $uploadDir.$newFileName;\r\n@@ -36,9 +36,11 @@\n     $stmt = $conn->prepare(\"UPDATE deliveries SET pdf_file=? WHERE id=?\");\r\n     $stmt->bind_param(\"si\",$newFileName,$delivery_id);\r\n     $stmt->execute();\r\n     $stmt->close();\r\n-    echo json_encode([\"success\"=>true]);\r\n+\r\n+    // ส่งชื่อไฟล์กลับเพื่ออัปเดตลิงก์\r\n+    echo json_encode([\"success\"=>true,\"pdf_file\"=>$newFileName]);\r\n } else {\r\n     echo json_encode([\"success\"=>false,\"message\"=>\"อัพโหลดไฟล์ล้มเหลว\"]);\r\n }\r\n \r\n"
                },
                {
                    "date": 1758718316735,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,32 +16,28 @@\n \r\n $delivery_id = intval($_POST['delivery_id']);\r\n $file = $_FILES['pdf_file'];\r\n \r\n-// ตรวจสอบนามสกุล PDF\r\n $ext = pathinfo($file['name'], PATHINFO_EXTENSION);\r\n if(strtolower($ext)!=\"pdf\"){\r\n     echo json_encode([\"success\"=>false,\"message\"=>\"ไฟล์ต้องเป็น PDF\"]);\r\n     exit;\r\n }\r\n \r\n-// สร้างโฟลเดอร์ถ้ายังไม่มี\r\n-$uploadDir = \"../uploads/deliveries/\"; // ../ ขึ้นไปหนึ่งระดับ\r\n+$uploadDir = \"../uploads/deliveries/\";\r\n if(!is_dir($uploadDir)) mkdir($uploadDir,0777,true);\r\n \r\n $newFileName = \"delivery_\".$delivery_id.\"_\".time().\".pdf\";\r\n $uploadPath = $uploadDir.$newFileName;\r\n \r\n if(move_uploaded_file($file['tmp_name'],$uploadPath)){\r\n-    // อัพเดต database\r\n     $stmt = $conn->prepare(\"UPDATE deliveries SET pdf_file=? WHERE id=?\");\r\n     $stmt->bind_param(\"si\",$newFileName,$delivery_id);\r\n     $stmt->execute();\r\n     $stmt->close();\r\n-\r\n-    // ส่งชื่อไฟล์กลับเพื่ออัปเดตลิงก์\r\n     echo json_encode([\"success\"=>true,\"pdf_file\"=>$newFileName]);\r\n } else {\r\n     echo json_encode([\"success\"=>false,\"message\"=>\"อัพโหลดไฟล์ล้มเหลว\"]);\r\n }\r\n \r\n $conn->close();\r\n+?>\r\n"
                },
                {
                    "date": 1758718473029,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,8 +16,9 @@\n \r\n $delivery_id = intval($_POST['delivery_id']);\r\n $file = $_FILES['pdf_file'];\r\n \r\n+// ตรวจสอบ PDF\r\n $ext = pathinfo($file['name'], PATHINFO_EXTENSION);\r\n if(strtolower($ext)!=\"pdf\"){\r\n     echo json_encode([\"success\"=>false,\"message\"=>\"ไฟล์ต้องเป็น PDF\"]);\r\n     exit;\r\n"
                },
                {
                    "date": 1758718704862,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,29 +16,36 @@\n \r\n $delivery_id = intval($_POST['delivery_id']);\r\n $file = $_FILES['pdf_file'];\r\n \r\n-// ตรวจสอบ PDF\r\n-$ext = pathinfo($file['name'], PATHINFO_EXTENSION);\r\n-if(strtolower($ext)!=\"pdf\"){\r\n+// ตรวจสอบนามสกุล PDF\r\n+$ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));\r\n+if($ext != \"pdf\"){\r\n     echo json_encode([\"success\"=>false,\"message\"=>\"ไฟล์ต้องเป็น PDF\"]);\r\n     exit;\r\n }\r\n \r\n+// สร้างโฟลเดอร์ถ้ายังไม่มี\r\n $uploadDir = \"../uploads/deliveries/\";\r\n if(!is_dir($uploadDir)) mkdir($uploadDir,0777,true);\r\n \r\n-$newFileName = \"delivery_\".$delivery_id.\"_\".time().\".pdf\";\r\n-$uploadPath = $uploadDir.$newFileName;\r\n+// ตั้งชื่อไฟล์เป็น delivery[ID]_[timestamp].pdf\r\n+$newFileName = \"delivery\".$delivery_id.\"_\".time().\".pdf\";\r\n+$uploadPath = $uploadDir . $newFileName;\r\n \r\n+// อัปโหลดไฟล์\r\n if(move_uploaded_file($file['tmp_name'],$uploadPath)){\r\n+    // อัปเดตฐานข้อมูล\r\n     $stmt = $conn->prepare(\"UPDATE deliveries SET pdf_file=? WHERE id=?\");\r\n-    $stmt->bind_param(\"si\",$newFileName,$delivery_id);\r\n-    $stmt->execute();\r\n+    $stmt->bind_param(\"si\", $newFileName, $delivery_id);\r\n+    if($stmt->execute()){\r\n+        echo json_encode([\"success\"=>true, \"pdf_file\"=>$newFileName]);\r\n+    } else {\r\n+        echo json_encode([\"success\"=>false, \"message\"=>\"อัปเดตฐานข้อมูลล้มเหลว\"]);\r\n+    }\r\n     $stmt->close();\r\n-    echo json_encode([\"success\"=>true,\"pdf_file\"=>$newFileName]);\r\n } else {\r\n-    echo json_encode([\"success\"=>false,\"message\"=>\"อัพโหลดไฟล์ล้มเหลว\"]);\r\n+    echo json_encode([\"success\"=>false, \"message\"=>\"อัปโหลดไฟล์ล้มเหลว\"]);\r\n }\r\n \r\n $conn->close();\r\n ?>\r\n"
                },
                {
                    "date": 1758718786658,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,36 +16,31 @@\n \r\n $delivery_id = intval($_POST['delivery_id']);\r\n $file = $_FILES['pdf_file'];\r\n \r\n-// ตรวจสอบนามสกุล PDF\r\n $ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));\r\n if($ext != \"pdf\"){\r\n     echo json_encode([\"success\"=>false,\"message\"=>\"ไฟล์ต้องเป็น PDF\"]);\r\n     exit;\r\n }\r\n \r\n-// สร้างโฟลเดอร์ถ้ายังไม่มี\r\n $uploadDir = \"../uploads/deliveries/\";\r\n if(!is_dir($uploadDir)) mkdir($uploadDir,0777,true);\r\n \r\n-// ตั้งชื่อไฟล์เป็น delivery[ID]_[timestamp].pdf\r\n $newFileName = \"delivery\".$delivery_id.\"_\".time().\".pdf\";\r\n $uploadPath = $uploadDir . $newFileName;\r\n \r\n-// อัปโหลดไฟล์\r\n if(move_uploaded_file($file['tmp_name'],$uploadPath)){\r\n-    // อัปเดตฐานข้อมูล\r\n     $stmt = $conn->prepare(\"UPDATE deliveries SET pdf_file=? WHERE id=?\");\r\n     $stmt->bind_param(\"si\", $newFileName, $delivery_id);\r\n     if($stmt->execute()){\r\n         echo json_encode([\"success\"=>true, \"pdf_file\"=>$newFileName]);\r\n     } else {\r\n-        echo json_encode([\"success\"=>false, \"message\"=>\"อัปเดตฐานข้อมูลล้มเหลว\"]);\r\n+        echo json_encode([\"success\"=>false,\"message\"=>\"อัปเดตฐานข้อมูลล้มเหลว\"]);\r\n     }\r\n     $stmt->close();\r\n } else {\r\n-    echo json_encode([\"success\"=>false, \"message\"=>\"อัปโหลดไฟล์ล้มเหลว\"]);\r\n+    echo json_encode([\"success\"=>false,\"message\"=>\"อัปโหลดไฟล์ล้มเหลว\"]);\r\n }\r\n \r\n $conn->close();\r\n ?>\r\n"
                }
            ],
            "date": 1758716597557,
            "name": "Commit-0",
            "content": "<?php\r\n$host=\"localhost\";\r\n$user=\"root\";\r\n$pass=\"\";\r\n$dbname=\"shop_it\";\r\n\r\n$conn = new mysqli($host,$user,$pass,$dbname);\r\nif($conn->connect_error){\r\n    die(json_encode([\"success\"=>false,\"message\"=>\"เชื่อมต่อ DB ล้มเหลว\"]));\r\n}\r\n\r\nif(!isset($_POST['delivery_id']) || !isset($_FILES['pdf_file'])){\r\n    echo json_encode([\"success\"=>false,\"message\"=>\"ข้อมูลไม่ครบ\"]);\r\n    exit;\r\n}\r\n\r\n$delivery_id = intval($_POST['delivery_id']);\r\n$file = $_FILES['pdf_file'];\r\n\r\n// ตรวจสอบนามสกุล PDF\r\n$ext = pathinfo($file['name'], PATHINFO_EXTENSION);\r\nif(strtolower($ext)!=\"pdf\"){\r\n    echo json_encode([\"success\"=>false,\"message\"=>\"ไฟล์ต้องเป็น PDF\"]);\r\n    exit;\r\n}\r\n\r\n// สร้างโฟลเดอร์ถ้ายังไม่มี\r\n$uploadDir = \"uploads/deliveries/\";\r\nif(!is_dir($uploadDir)) mkdir($uploadDir,0777,true);\r\n\r\n$newFileName = \"delivery_\".$delivery_id.\"_\".time().\".pdf\";\r\n$uploadPath = $uploadDir.$newFileName;\r\n\r\nif(move_uploaded_file($file['tmp_name'],$uploadPath)){\r\n    // อัพเดต database\r\n    $stmt = $conn->prepare(\"UPDATE deliveries SET pdf_file=? WHERE id=?\");\r\n    $stmt->bind_param(\"si\",$newFileName,$delivery_id);\r\n    $stmt->execute();\r\n    $stmt->close();\r\n    echo json_encode([\"success\"=>true]);\r\n} else {\r\n    echo json_encode([\"success\"=>false,\"message\"=>\"อัพโหลดไฟล์ล้มเหลว\"]);\r\n}\r\n\r\n$conn->close();\r\n"
        }
    ]
}